#+title: Majutsu (Jujutsu) for Emacs

Majutsu provides a magit-inspired interface for
[[https://github.com/martinvonz/jj][Jujutsu]], offering an efficient way to
interact with JJ repositories from within Emacs.

This project started life as a fork of [[https://github.com/bolivier/jj-mode.el][bolivier/jj-mode.el]].
I dropped the fork relationship after deciding to pursue breaking changes
—most notably a reworked Magit-style log UI, a new template DSL,
and different window/message handling—that fundamentally diverge from
the original package’s scope.

* Features
- *Magit-style log viewer* with collapsible sections and syntax highlighting
- *Interactive rebase* with visual source/destination selection via transients
- *Bookmark management* with create, abandon, forget, and track operations
- *Commit and describe* with dedicated message buffers and window management
- *Interactive diff viewing* with visual range selection and dedicated buffers
- *Context-sensitive actions* via DWIM (Do What I Mean) Enter key behavior
- *Git integration* with push/fetch operations and configurable options
- *Log transient* to tweak revsets, limits, and path filters on the fly
- *Revset Builder* for interactively constructing complex revset expressions
- *Operation Log* viewer (~majutsu-op-log~) to inspect repo history
- *Built-in conflict resolution* listing conflicted files and opening them in smerge-mode
- *Composable templates* through the bundled ~majutsu-template~ DSL for JJ output
- *Native Evil integration* with sensible defaults and keybindings

* Requirements
- Emacs 26.1 or later
- [[https://github.com/jj-vcs/jj][Jujutsu (jj)]] installed and in PATH
- [[https://magit.vc/][magit]] (for section management and UI components)
- [[https://github.com/magit/transient][transient]] (usually bundled with magit)
- [[https://github.com/magit/with-editor][with-editor]] (usually bundled with magit)

* Installation
** Doom Emacs
#+begin_src emacs-lisp
(package! majutsu :recipe (:host github :repo "0WD0/majutsu"))
#+end_src

If you prefer a pre-built Doom module, you can drop in
[[https://github.com/0WD0/doom/tree/main/modules/tools/majutsu][0WD0/doom/modules/tools/majutsu]]
and enable it in your Doom config.

** use-package with straight.el
#+begin_src emacs-lisp
(use-package majutsu
  :straight (:host github :repo "0WD0/majutsu"))
#+end_src

** use-package with built-in package-vc integration
#+begin_src emacs-lisp
(use-package majutsu
  :vc (:url "https://github.com/0WD0/majutsu"))
#+end_src

** Manual
Clone this repository and add it to your load path:
#+begin_src emacs-lisp
(add-to-list 'load-path "/path/to/majutsu")
(require 'majutsu)
#+end_src

* Usage
Start with ~M-x majutsu-log~ to open the main interface. Each project gets its own
buffer (~*majutsu-log:project-name*~).

** Key Bindings
*** Navigation
- ~n~ / ~p~ - Navigate between sections
- ~RET~ - Context-sensitive action (edit changeset, jump to file/line in diffs)
- ~.~ - Jump to current changeset (@)
- ~TAB~ - Toggle section folding

*** Basic Operations
- ~g~ - Refresh log
- ~c~ - Commit (opens message buffer)
- ~d~ - Describe changeset at point (opens message buffer)
- ~e~ - Edit changeset (jj edit)
- ~u~ - Undo last operation
- ~l~ - Log options transient
- ~R~ - Redo last operation
- ~s~ - Squash
- ~N~ - New changeset at point (~C-u N~ opens the transient)
- ~y~ - Duplicate changeset at point (~C-u y~ opens duplicate transient)
- ~Y~ - Duplicate transient quick access

*** Advanced Operations
- ~r~ - Rebase transient menu
  - ~s~ - Set rebase source
  - ~d~ - Toggle rebase destination
  - ~r~ - Execute rebase
  - ~c~ - Clear selections
- ~b~ - Bookmark transient menu
  - ~c~ - Create bookmark
  - ~d~ - Delete bookmark
  - ~f~ - Forget bookmark
  - ~l~ - List bookmarks
  - ~s~ - Set bookmark to revision
  - ~m~ - Move bookmark(s) to revision
  - ~M~ - Move bookmark(s) to revision --allow-backwards
  - ~r~ - Rename bookmark
  - ~t~ - Track remote bookmark
  - ~u~ - Untrack remote bookmark
- ~D~ - Diff transient menu
  - ~f~ - Set 'from' revision
  - ~t~ - Set 'to' revision
  - ~d~ - Execute diff (uses selections or DWIM)
  - ~p~ - Diff parent
- ~G~ - Git operations transient
  - ~-n~ - Toggle --allow-new flag
  - ~-b~ - Set bookmark to push
  - ~p~ - Push
  - ~f~ - Fetch

*** Conflict Resolution
- ~E~ - Edit conflicts with ediff
- ~M~ - Edit conflicts with smerge-mode

*** Message Buffers
Majutsu relies on [[https://github.com/magit/with-editor][with-editor]] to populate commit/describe messages.
When the edit buffer opens:
- ~C-c C-c~ - Finish and execute
- ~C-c C-k~ - Cancel

** Workflow Example
1. ~M-x majutsu-log~ - Open JJ interface
2. Navigate to desired changeset with ~j~ / ~k~
3. ~c~ - Commit current changes
4. Edit message, ~C-c C-c~ to finish
5. ~r~ - Open rebase menu, select source with ~s~, destinations with ~d~, execute with ~r~
6. ~b~ - Manage bookmarks as needed
7. ~G~ ~p~ - Push to remote

* Template DSL
Majutsu includes ~majutsu-template.el~, an embedded DSL for building JJ
templates directly from Elisp (used by ~majutsu--log-template~).

- Use ~tpl~ / ~tpl-compile~ to embed literal vectors at compile time.
- Keyword sugar covers JJ built-ins plus helpers registered with
  ~majutsu-template-defkeyword~ or methods declared with ~:keyword t~.
- See =docs/majutsu-template-spec.org= for the evolving spec and TODO list.
- Usage patterns and safeguards live in =test/majutsu-template-test.el=.

* Configuration
#+begin_src emacs-lisp
;; Customize jj executable path if needed
(setq majutsu-executable "/path/to/jj")
#+end_src

* Evil integration
Majutsu ships with ~majutsu-evil.el~, so Evil users no longer need an external
module.  Once Evil is loaded, the integration installs motion-friendly defaults
and reuses the Doom module keybindings (e.g., ~.~ for ~majutsu-goto-current~,
~gr~ / ~R~ for refresh, ~E~ / ~M~ for diffedit, etc.).

- Toggle the integration entirely via ~M-x customize-group RET majutsu-evil RET~
  or by setting ~majutsu-evil-enable-integration~ to ~nil~.
- Change the default state (normal/motion/emacs/…) by customizing
  ~majutsu-evil-initial-state~.

** Evil keybinding cheat-sheet
All bindings below live in ~majutsu-mode-map~ unless noted otherwise and apply
to Evil's normal/visual/motion states (matching the defaults set by
~majutsu-evil-initial-state~):

- ~.~ → ~majutsu-goto-current~
- ~R~ / ~g r~ → ~majutsu-log-refresh~
- ~c~ → ~majutsu-commit~
- ~e~ → ~majutsu-edit-changeset~
- ~u~ → ~majutsu-undo~
- ~C-r~ → ~majutsu-redo~
- ~s~ → ~majutsu-squash-transient~
- ~l~ → ~majutsu-log-transient~
- ~d~ → ~majutsu-describe~
- ~x~ → ~majutsu-abandon~
- ~b~ → ~majutsu-bookmark-transient~
- ~r~ → ~majutsu-rebase-transient~
- ~D~ → ~majutsu-diff~
- ~E~ → ~majutsu-diffedit-emacs~
- ~M~ → ~majutsu-diffedit-smerge~
- ~?~ → ~majutsu-dispatch~
- ~RET~ (normal/motion) → ~majutsu-enter-dwim~
- ~RET~ (visual) → ~majutsu-enter-dwim~ on the active region

In ~majutsu-diff-mode-map~, ~RET~ is also bound (normal/visual/motion) to
~majutsu-enter-dwim~ so diff hunk selections behave consistently.

When [[https://github.com/hlissner/evil-snipe][evil-snipe]] is present, Majutsu automatically calls
~turn-off-evil-snipe-mode~ and ~turn-off-evil-snipe-override-mode~ on
~majutsu-mode-hook~ to avoid conflicting motions inside Majutsu buffers.

* Contributing
Issues and pull requests welcome! This project aims to provide a solid JJ
interface while maintaining magit-like usability patterns.
